<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইসমত ২ হাজার কোড - ডিজিটাল প্রোডাক্ট শপ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark Theme Colors (Default) */
            --color-bg: #121212;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-surface: #1f1f1f;
            --color-glass-bg: rgba(31, 31, 31, 0.7);
            --color-glass-border: rgba(255, 255, 255, 0.1);
            --color-input-bg: #374151;
            --color-primary: #f59e0b;
            --color-primary-hover: #d97706;
            --color-primary-text: #121212;
            --color-primary-text-alt: #ffffff;
        }

        .light-mode {
            /* Light Theme Colors */
            --color-bg: #f9fafb;
            --color-text: #111827;
            --color-text-muted: #6b7281;
            --color-surface: #ffffff;
            --color-glass-bg: rgba(255, 255, 255, 0.7);
            --color-glass-border: rgba(0, 0, 0, 0.1);
            --color-input-bg: #e5e7eb;
            --color-primary: #f59e0b;
            --color-primary-hover: #d97706;
            --color-primary-text: #ffffff;
            --color-primary-text-alt: #121212;
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.3s, color 0.3s;
        }
        .glass-effect {
            background: var(--color-glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--color-glass-border);
        }
        .hero-gradient {
            background: radial-gradient(circle at 50% 0%, rgba(250, 204, 21, 0.1), transparent 60%);
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(150%);
            transition: transform 0.5s ease-in-out;
            z-index: 1050;
        }
        .notification.show { transform: translateY(0); }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--color-surface);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s;
            position: relative;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        #cart-modal .modal-content {
            margin-left: auto;
            margin-right: 0;
            height: 100%;
            border-radius: 12px 0 0 12px;
            transform: translateX(100%);
        }
        #cart-modal.active .modal-content {
             transform: translateX(0);
        }
        .category-btn.active {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .favorite-btn.favorited { color: #ef4444; }
        .dashboard-nav-item.active {
            background-color: var(--color-primary-hover);
            color: white;
        }
        .cart-item-checkbox {
            accent-color: #f59e0b;
        }
        /* Color variable applications */
        .text-gray-300, .text-gray-400 { color: var(--color-text-muted); }
        h1, h2, h3, h4, h5, h6, .text-white { color: var(--color-text); }
        .bg-gray-800, input.bg-gray-800, textarea.bg-gray-800, select.bg-gray-800 { 
            background-color: var(--color-input-bg);
            color: var(--color-text);
        }
        .bg-yellow-500 {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .text-yellow-500, .border-yellow-500 {
            color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .hover\:bg-yellow-500:hover {
            background-color: var(--color-primary);
            color: var(--color-primary-text-alt) !important;
        }
         .hover\:bg-yellow-600:hover {
            background-color: var(--color-primary-hover);
        }
        .text-yellow-400 { color: var(--color-primary); }

        /* Slider Styles */
        .slider-container {
            position: relative;
            width: 100%;
            height: 60vh;
            overflow: hidden;
        }
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .slide.active { opacity: 1; }
        .slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .slide-content {
            position: absolute;
            bottom: 10%;
            left: 5%;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 8px;
            max-width: 50%;
        }
        .slider-nav {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .slider-nav button {
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header class="glass-effect sticky top-0 z-50">
        <nav class="container mx-auto px-4 lg:px-6 py-3 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold" data-lang-key="site_title">ইসমত কোড</h1>
            <div class="hidden lg:flex items-center space-x-6">
                <a href="#" id="home-link" class="hover:text-yellow-500 transition" data-lang-key="nav_home">হোম</a>
                <a href="#products" class="hover:text-yellow-500 transition" data-lang-key="nav_products">প্রোডাক্টস</a>
                <a href="#" id="sell-product-link" class="hover:text-yellow-500 transition" data-lang-key="nav_sell">পণ্য সেল করুন</a>
                <a href="#" id="dashboard-link" class="hover:text-yellow-500 transition" data-lang-key="nav_account">আমার অ্যাকাউন্ট</a>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative hidden md:block">
                    <input type="text" id="search-bar" data-lang-key="search_placeholder" placeholder="প্রোডাক্ট খুঁজুন..." class="bg-gray-800 placeholder-gray-400 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full">
                    <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                </div>
                <!-- Language Selector -->
                <div class="flex items-center gap-1 glass-effect p-1 rounded-full">
                    <button id="lang-bn" class="px-2 py-1 text-sm rounded-full bg-yellow-500 text-black">বাং</button>
                    <button id="lang-en" class="px-2 py-1 text-sm rounded-full">Eng</button>
                </div>
                <!-- Theme Toggle Button -->
                <button id="theme-toggle-btn" class="hover:text-yellow-500 transition">
                    <svg id="moon-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                    </svg>
                    <svg id="sun-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                    </svg>
                </button>
                <button id="favorite-icon" class="relative hover:text-yellow-500 transition">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg>
                    <span id="favorite-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <button id="cart-icon" class="relative hover:text-yellow-500 transition">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.823-6.814a.75.75 0 0 0-.693-.941H5.617l-.755-2.818A.75.75 0 0 0 3.86 3H2.25M8 21a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm10.5 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" /></svg>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <button id="auth-btn" class="bg-yellow-500 hover:bg-yellow-600 font-bold py-2 px-4 rounded-lg transition duration-300 text-sm" data-lang-key="login_btn">লগইন</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Slider Section -->
        <section id="slider" class="slider-container">
            <!-- Slides will be dynamically generated here -->
            <div class="slider-nav">
                <button id="prev-slide">&lt;</button>
                <button id="next-slide">&gt;</button>
            </div>
        </section>

        <!-- Hero Section -->
        <main class="hero-gradient">
            <section class="container mx-auto px-6 py-24 text-center">
                <h2 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight" data-lang-key="hero_title">আপনার প্রয়োজনীয় সকল ডিজিটাল প্রোডাক্টস</h2>
                <p class="text-lg max-w-2xl mx-auto mb-8" data-lang-key="hero_subtitle">ওয়েব টেমপ্লেট, গ্রাফিক্স ডিজাইন, সফটওয়্যার এবং আরও অনেক কিছু, সবই এক জায়গায়।</p>
                <a href="#products" class="bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-8 rounded-lg text-lg transition duration-300" data-lang-key="hero_button">প্রোডাক্ট দেখুন</a>
            </section>
        </main>

        <!-- Products Section -->
        <section id="products" class="py-20">
            <div class="container mx-auto px-6">
                <h3 class="text-3xl font-bold text-center mb-4" data-lang-key="products_title">আমাদের সেরা প্রোডাক্টস</h3>
                <div id="category-filters" class="flex justify-center flex-wrap gap-2 md:gap-4 mb-12"></div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="col-span-full text-center py-10">
                        <p class="text-lg" data-lang-key="loading_text">লোড হচ্ছে...</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- User Dashboard Section (Initially Hidden) -->
    <section id="dashboard" class="hidden py-20">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl font-bold mb-8" data-lang-key="dashboard_title">আমার অ্যাকাউন্ট ড্যাশবোর্ড</h2>
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Dashboard Navigation -->
                <div class="w-full md:w-1/4 glass-effect p-4 rounded-lg self-start">
                    <nav id="dashboard-nav" class="flex flex-col space-y-2">
                        <button data-target="my-orders" class="text-left p-3 rounded-md hover:bg-gray-700 transition dashboard-nav-item active" data-lang-key="dashboard_nav_orders">আমার অর্ডার</button>
                        <button data-target="my-favorites" class="text-left p-3 rounded-md hover:bg-gray-700 transition dashboard-nav-item" data-lang-key="dashboard_nav_favorites">ফেভারিট পণ্য</button>
                        <button data-target="upload-product" class="text-left p-3 rounded-md hover:bg-gray-700 transition dashboard-nav-item" data-lang-key="dashboard_nav_upload">আপনার পণ্য আপলোড করুন</button>
                        <button data-target="settings" class="text-left p-3 rounded-md hover:bg-gray-700 transition dashboard-nav-item" data-lang-key="dashboard_nav_settings">সেটিংস</button>
                    </nav>
                </div>
                <!-- Dashboard Content -->
                <div class="w-full md:w-3/4">
                    <div id="my-orders" class="dashboard-content">
                        <h3 class="text-2xl font-semibold mb-4" data-lang-key="orders_title">অর্ডার হিস্টোরি</h3>
                        <div class="glass-effect p-6 rounded-lg" id="orders-list">
                            <!-- Orders will be rendered here -->
                        </div>
                    </div>
                    <div id="my-favorites" class="dashboard-content hidden">
                         <h3 class="text-2xl font-semibold mb-4" data-lang-key="favorites_title">আপনার ফেভারিট পণ্য</h3>
                         <div id="favorites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                              <!-- Favorite items will be rendered here -->
                         </div>
                    </div>
                    <div id="upload-product" class="dashboard-content hidden">
                        <h3 class="text-2xl font-semibold mb-4" data-lang-key="upload_title">নতুন পণ্য যোগ করুন</h3>
                        <div class="glass-effect p-6 rounded-lg">
                            <form id="upload-form" class="space-y-4">
                                <input id="upload-name" type="text" placeholder="পণ্যের নাম" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                                <textarea id="upload-desc" placeholder="পণ্যের বিবরণ" rows="4" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
                                <input id="upload-price" type="number" placeholder="পণ্যের মূল্য (৳)" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                                <input id="upload-category" type="text" placeholder="ক্যাটেগরি (যেমন: Web Templates)" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                                <input id="upload-image" type="text" placeholder="পণ্যের ছবির URL" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-4 rounded-lg transition duration-300" data-lang-key="upload_button">পণ্য আপলোড করুন</button>
                            </form>
                        </div>
                    </div>
                     <div id="settings" class="dashboard-content hidden">
                          <h3 class="text-2xl font-semibold mb-4" data-lang-key="settings_title">অ্যাকাউন্ট সেটিংস</h3>
                           <div class="glass-effect p-6 rounded-lg">
                            <div id="profile-display" class="mb-6">
                                <h4 id="profile-full-name" class="text-xl font-bold"></h4>
                                <p id="profile-email"></p>
                                <p id="profile-mobile"></p>
                            </div>
                            <h4 class="text-xl font-semibold mb-3" data-lang-key="payout_title">প্রোফাইল ও পেমেন্ট তথ্য</h4>
                            <p class="text-sm mb-4" data-lang-key="payout_desc">আপনার পণ্য বিক্রি হলে, আমরা নিচের তথ্যে আপনাকে পেমেন্ট পাঠাব।</p>
                            <form id="settings-form" class="space-y-4">
                                <h5 class="text-lg font-semibold border-b border-gray-700 pb-2" data-lang-key="settings_optional_title">ঐচ্ছিক তথ্য (প্রোফাইল পূর্ণ করুন)</h5>
                                <textarea id="settings-address" placeholder="আপনার ঠিকানা" rows="3" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
                                <input id="settings-house" type="text" placeholder="বাড়ির নম্বর" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <input id="settings-zip" type="text" placeholder="জিপ কোড" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                
                                <h5 class="text-lg font-semibold border-b border-gray-700 pb-2 pt-4" data-lang-key="payout_title">পেমেন্ট পাওয়ার তথ্য</h5>
                                <select id="payout-method" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                    <option value="bKash">বিকাশ</option>
                                    <option value="Nagad">নগদ</option>
                                    <option value="Rocket">রকেট</option>
                                </select>
                                <input id="payout-number" type="text" placeholder="আপনার অ্যাকাউন্ট নম্বর" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition" data-lang-key="payout_save_btn">তথ্য সেভ করুন</button>
                            </form>
                           </div>
                     </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black py-8">
        <div class="container mx-auto px-6 text-center">
            <div class="flex justify-center gap-4 mb-4">
                <a href="#" id="terms-link" class="hover:text-yellow-400" data-lang-key="footer_terms">টার্মস এন্ড কন্ডিশনস</a>
            </div>
            <p data-lang-key="footer_copyright">&copy; ২০২৫ ইসমত ২ হাজার কোড। সর্বসত্ত্ব সংরক্ষিত।</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="notification" class="notification"></div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-auth-modal" class="absolute top-4 right-4 hover:text-white text-2xl font-bold">&times;</button>
            <div id="login-view">
                 <h3 class="text-2xl font-bold text-center mb-6" data-lang-key="login_title">স্বাগতম!</h3>
                 <form id="login-form" class="space-y-4">
                     <input id="login-email" type="email" placeholder="আপনার ইমেইল" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <input id="login-password" type="password" placeholder="আপনার পাসওয়ার্ড" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-4 rounded-lg transition duration-300" data-lang-key="login_form_btn">লগইন করুন</button>
                 </form>
                 <div class="mt-6 text-center">
                     <p class="text-sm" data-lang-key="login_no_account">অ্যাকাউন্ট নেই?</p>
                     <button type="button" id="show-register-view" class="w-full mt-2 py-2 px-4 border border-yellow-500 text-yellow-500 rounded-lg hover:bg-yellow-500 hover:text-black transition" data-lang-key="login_create_account">এখনি তৈরি করুন</button>
                 </div>
            </div>
            <div id="register-view" class="hidden">
                 <h3 class="text-2xl font-bold text-center mb-6" data-lang-key="register_title">অ্যাকাউন্ট তৈরি করুন</h3>
                 <form id="register-form" class="space-y-4">
                     <input id="register-name" type="text" placeholder="আপনার পুরো নাম" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <input id="register-mobile" type="tel" placeholder="আপনার মোবাইল নম্বর" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <input id="register-email" type="email" placeholder="আপনার ইমেইল" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <input id="register-password" type="password" placeholder="একটি পাসওয়ার্ড দিন" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <input id="register-confirm-password" type="password" placeholder="পাসওয়ার্ডটি আবার দিন" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                     <div class="flex items-center space-x-2">
                         <input type="checkbox" id="register-terms" class="h-4 w-4 bg-gray-800 border-gray-600 text-yellow-500 focus:ring-yellow-600" required>
                         <label for="register-terms" class="text-sm" data-lang-key="register_terms_agree">আমি <a href="#" id="register-terms-link" class="text-yellow-400 hover:underline">শর্তাবলীতে</a> সম্মত।</label>
                     </div>
                     <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-4 rounded-lg transition duration-300" data-lang-key="register_form_btn">রেজিস্টার করুন</button>
                 </form>
                 <div class="mt-6 text-center">
                     <p class="text-sm" data-lang-key="register_has_account">ইতিমধ্যে অ্যাকাউন্ট আছে?</p>
                     <button type="button" id="show-login-view" class="w-full mt-2 py-2 px-4 border border-yellow-500 text-yellow-500 rounded-lg hover:bg-yellow-500 hover:text-black transition" data-lang-key="register_login">লগইন করুন</button>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <button id="close-cart-modal" class="absolute top-4 right-4 hover:text-white text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-6" data-lang-key="cart_title">আপনার কার্ট</h3>
            <div id="cart-items" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Cart items will be injected here -->
            </div>
            <div class="mt-6 border-t border-gray-700 pt-4">
                <div class="flex justify-between items-center font-bold text-lg">
                    <span data-lang-key="cart_total">নির্বাচিত মোট:</span>
                    <span id="cart-total">৳০</span>
                </div>
                <button id="checkout-btn" class="w-full mt-4 bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-4 rounded-lg transition duration-300" data-lang-key="cart_checkout">চেকআউট করুন</button>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-payment-modal" class="absolute top-4 right-4 hover:text-white text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4" data-lang-key="payment_title">পেমেন্ট সম্পন্ন করুন</h3>
            <div class="text-center p-4 bg-gray-800 rounded-lg">
                <p data-lang-key="payment_instruction_1">নিচের নম্বরে সর্বমোট <strong id="payment-amount" class="text-yellow-400"></strong> টাকা পাঠান।</p>
                <p id="gateway-number" class="text-2xl font-bold my-2 text-green-400">লোড হচ্ছে...</p>
                <p class="text-sm" data-lang-key="payment_instruction_2">(এটি একটি <span id="gateway-name"></span> নম্বর, পেমেন্ট অপশন ব্যবহার করুন)</p>
            </div>
            <form id="payment-form" class="space-y-4 mt-6">
                 <input id="payment-phone" type="text" placeholder="যে নম্বর থেকে টাকা পাঠিয়েছেন" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                 <input id="payment-trxid" type="text" placeholder="ট্রানজকশন আইডি (TrxID)" class="w-full bg-gray-800 p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                 <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition" data-lang-key="payment_confirm_btn">অর্ডার কনফার্ম করুন</button>
            </form>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal-overlay">
        <div class="modal-content max-w-2xl">
            <button id="close-terms-modal" class="absolute top-4 right-4 hover:text-white text-2xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-6" data-lang-key="terms_title">টার্মস এন্ড কন্ডিশনস</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto pr-4">
                <p data-lang-key="terms_p1">আমাদের ওয়েবসাইটে আপনাকে স্বাগতম। এই সাইট ব্যবহার করার মাধ্যমে, আপনি আমাদের শর্তাবলীর সাথে একমত হচ্ছেন।</p>
                <p data-lang-key="terms_p2">যেকোনো পণ্য কেনার আগে তার বিবরণ ভালোভাবে পড়ে নিন। ডিজিটাল পণ্য হওয়ায় কোনো রিফান্ডের ব্যবস্থা নেই। আমাদের কন্টেন্ট কপি করা নিষিদ্ধ।</p>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, onSnapshot, addDoc, deleteDoc, doc, setDoc, getDoc, query, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        
        const firebaseConfig = firebaseConfigString ? JSON.parse(firebaseConfigString) : {
            apiKey: "AIzaSyB6rH8V0TClZ_aigoUBPrS8BFzscG9_Dz8",
            authDomain: "e-site-62560.firebaseapp.com",
            databaseURL: "https://e-site-62560-default-rtdb.firebaseio.com",
            projectId: "e-site-62560",
            storageBucket: "e-site-62560.firebasestorage.app",
            messagingSenderId: "823317877501",
            appId: "1:823317877501:web:112d400e1f45533613a494",
            measurementId: "G-V5933K4NYK"
        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let notificationTimeout;
        function showNotification(message, type = 'success') {
            const el = document.getElementById('notification');
            if (!el) return;
            if (notificationTimeout) clearTimeout(notificationTimeout);
            el.innerText = message;
            el.style.backgroundColor = type === 'success' ? '#10B981' : '#EF4444';
            el.classList.add('show');
            notificationTimeout = setTimeout(() => el.classList.remove('show'), 3000);
        }

        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("Firebase config is not available or invalid.");
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.querySelector('p').innerText = "সাইট লোড করা যায়নি।";
            showNotification("সাইট লোড হতে একটি গুরুতর সমস্যা হয়েছে।", "error");
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let state = {
                products: [], banners: [], cart: [], favorites: [], user: null, siteSettings: null,
                currentCategory: 'All', searchTerm: '', checkoutItems: [], selectedCartItemIds: new Set(),
                unsubscribeProducts: () => {}, unsubscribeBanners: () => {}, unsubscribeCart: () => {}, unsubscribeFavorites: () => {}, unsubscribeOrders: () => {}, unsubscribeSiteSettings: () => {}
            };
            
            const translations = {
                bn: { site_title: "ইসমত কোড", nav_home: "হোম", nav_products: "প্রোডাক্টস", nav_sell: "পণ্য সেল করুন", nav_account: "আমার অ্যাকাউন্ট", search_placeholder: "প্রোডাক্ট খুঁজুন...", login_btn: "লগইন", logout_btn: "লগআউট", hero_title: "আপনার প্রয়োজনীয় সকল ডিজিটাল প্রোডাক্টস", hero_subtitle: "ওয়েব টেমপ্লেট, গ্রাফিক্স ডিজাইন, সফটওয়্যার এবং আরও অনেক কিছু, সবই এক জায়গায়।", hero_button: "প্রোডাক্ট দেখুন", products_title: "আমাদের সেরা প্রোডাক্টস", footer_terms: "টার্মস এন্ড কন্ডিশনস", footer_copyright: "© ২০২৫ ইসমত ২ হাজার কোড। সর্বসত্ত্ব সংরক্ষিত।", terms_title: "টার্মস এন্ড কন্ডিশনস", terms_p1: "আমাদের ওয়েবসাইটে আপনাকে স্বাগতম। এই সাইট ব্যবহার করার মাধ্যমে, আপনি আমাদের শর্তাবলীর সাথে একমত হচ্ছেন।", terms_p2: "যেকোনো পণ্য কেনার আগে তার বিবরণ ভালোভাবে পড়ে নিন। ডিজিটাল পণ্য হওয়ায় কোনো রিফান্ডের ব্যবস্থা নেই। আমাদের কন্টেন্ট কপি করা নিষিদ্ধ।", slide1_title: "সকল ওয়েব টেমপ্লেটে ৫০% ছাড়!", slide1_desc: "আপনার স্বপ্নের ওয়েবসাইট বানান আমাদের প্রিমিয়াম টেমপ্লেট দিয়ে।", slide2_title: "এসে গেছে নতুন গ্রাফিক্স ডিজাইন কালেকশন", slide2_desc: "আপনার প্রজেক্টকে ফুটিয়ে তুলুন নতুন আঙ্গিকে।", login_title: "স্বাগতম!", login_form_btn: "লগইন করুন", login_no_account: "অ্যাকাউন্ট নেই?", login_create_account: "এখনি তৈরি করুন", register_title: "অ্যাকাউন্ট তৈরি করুন", register_form_btn: "রেজিস্টার করুন", register_has_account: "ইতিমধ্যে অ্যাকাউন্ট আছে?", register_login: "লগইন করুন", register_terms_agree: "আমি", dashboard_title: "আমার অ্যাকাউন্ট ড্যাশবোর্ড", dashboard_nav_orders: "আমার অর্ডার", dashboard_nav_favorites: "ফেভারিট পণ্য", dashboard_nav_upload: "আপনার পণ্য আপলোড করুন", dashboard_nav_settings: "সেটিংস", dashboard_nav_site_settings: "সাইট সেটিংস", site_settings_title: "সাইট পেমেন্ট সেটিংস", site_settings_desc: "গ্রাহকদের কাছ থেকে পেমেন্ট গ্রহণের জন্য এখানে আপনার পেমেন্ট গেটওয়ের তথ্য দিন।", orders_title: "অর্ডার হিস্টোরি", orders_none: "আপনার কোনো অর্ডার নেই।", favorites_title: "আপনার ফেভারিট পণ্য", favorites_none: "আপনার পছন্দের তালিকা খালি।", upload_title: "নতুন পণ্য যোগ করুন", upload_button: "পণ্য আপলোড করুন", settings_title: "অ্যাকাউন্ট সেটিংস", settings_optional_title: "ঐচ্ছিক তথ্য (প্রোফাইল পূর্ণ করুন)", payout_title: "পেমেন্ট পাওয়ার তথ্য", payout_desc: "আপনার পণ্য বিক্রি হলে, আমরা নিচের তথ্যে আপনাকে পেমেন্ট পাঠাব।", payout_save_btn: "তথ্য সেভ করুন", add_to_cart_btn: "কার্টে যোগ করুন", buy_now_btn: "এখনই কিনুন", cart_title: "আপনার কার্ট", cart_total: "নির্বাচিত মোট:", cart_checkout: "চেকআউট করুন", cart_empty: "আপনার কার্ট খালি।", payment_title: "পেমেন্ট সম্পন্ন করুন", payment_instruction_1: "নিচের নম্বরে সর্বমোট", payment_instruction_2: "(এটি একটি মার্চেন্ট নম্বর, পেমেন্ট অপশন ব্যবহার করুন)", payment_confirm_btn: "অর্ডার কনফার্ম করুন", loading_text: "লোড হচ্ছে...", critical_error: "একটি গুরুতর সমস্যা হয়েছে। অনুগ্রহ করে পৃষ্ঠাটি রিফ্রেশ করুন।" },
                en: { site_title: "Ismat Code", nav_home: "Home", nav_products: "Products", nav_sell: "Sell Product", nav_account: "My Account", search_placeholder: "Search for products...", login_btn: "Login", logout_btn: "Logout", hero_title: "All The Digital Products You Need", hero_subtitle: "Web templates, graphic designs, software, and much more, all in one place.", hero_button: "Browse Products", products_title: "Our Best Products", footer_terms: "Terms & Conditions", footer_copyright: "© 2025 Ismat 2 Thousand Code. All rights reserved.", terms_title: "Terms & Conditions", terms_p1: "Welcome to our website. By using this site, you agree to our terms and conditions.", terms_p2: "Please read the product descriptions carefully before purchasing. As these are digital products, there are no refunds. Copying our content is prohibited.", slide1_title: "50% Off On All Web Templates!", slide1_desc: "Build your dream website with our premium templates.", slide2_title: "New Graphics Design Collection Arrived", slide2_desc: "Elevate your project with a fresh new look.", login_title: "Welcome!", login_form_btn: "Log In", login_no_account: "No account?", login_create_account: "Create one now", register_title: "Create Account", register_form_btn: "Register", register_has_account: "Already have an account?", register_login: "Log In", register_terms_agree: "I agree to the", dashboard_title: "My Account Dashboard", dashboard_nav_orders: "My Orders", dashboard_nav_favorites: "Favorite Products", dashboard_nav_upload: "Upload Your Product", dashboard_nav_settings: "Settings", dashboard_nav_site_settings: "Site Settings", site_settings_title: "Site Payment Settings", site_settings_desc: "Provide your payment gateway information here to receive payments from customers.", orders_title: "Order History", orders_none: "You have no orders.", favorites_title: "Your Favorite Products", favorites_none: "Your favorites list is empty.", upload_title: "Add New Product", upload_button: "Upload Product", settings_title: "Account Settings", settings_optional_title: "Optional Info (Complete Profile)", payout_title: "Payout Information", payout_desc: "When your product sells, we will send the payment to the details below.", payout_save_btn: "Save Information", add_to_cart_btn: "Add to Cart", buy_now_btn: "Buy Now", cart_title: "Your Cart", cart_total: "Selected Total:", cart_checkout: "Checkout", cart_empty: "Your cart is empty.", payment_title: "Complete Payment", payment_instruction_1: "Please send a total of", payment_instruction_2: "(This is a merchant number, please use the Payment option)", payment_confirm_btn: "Confirm Order", loading_text: "Loading...", critical_error: "A critical error has occurred. Please refresh the page." }
            };

            function setLanguage(lang) {
                localStorage.setItem('language', lang);
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    const text = (key === 'login_btn' && state.user && !state.user.isAnonymous) 
                        ? translations[lang]['logout_btn'] 
                        : translations[lang][key];
                    if (text) {
                        if (el.placeholder) el.placeholder = text;
                        else if (key === 'register_terms_agree') {
                             el.innerHTML = `${text} <a href="#" id="register-terms-link" class="text-yellow-400 hover:underline">${lang === 'bn' ? 'শর্তাবলীতে' : 'Terms & Conditions'}</a>`;
                        }
                        else el.innerText = text;
                    }
                });
                document.getElementById('lang-bn').classList.toggle('bg-yellow-500', lang === 'bn');
                document.getElementById('lang-bn').classList.toggle('text-black', lang === 'bn');
                document.getElementById('lang-en').classList.toggle('bg-yellow-500', lang === 'en');
                document.getElementById('lang-en').classList.toggle('text-black', lang === 'en');
            }

            function renderProducts() {
                const listEl = document.getElementById('product-list');
                const loadingIndicator = document.getElementById('loading-indicator');
                if(loadingIndicator) loadingIndicator.style.display = 'none';

                listEl.innerHTML = '';
                const filtered = state.products.filter(p => (state.currentCategory === 'All' || p.category === state.currentCategory) && p.name.toLowerCase().includes(state.searchTerm.toLowerCase()));
                if (filtered.length === 0) {
                     listEl.innerHTML = `<p class="text-center col-span-full">কোনো প্রোডাক্ট পাওয়া যায়নি।</p>`;
                     return;
                }
                filtered.forEach(p => {
                    const isFav = state.favorites.includes(p.id);
                    const originalPriceHTML = p.originalPrice ? `<del class="text-sm">৳${p.originalPrice.toLocaleString('bn-BD')}</del>` : '';
                    const card = document.createElement('div');
                    card.className = "glass-effect rounded-lg overflow-hidden shadow-lg p-5 flex flex-col transform hover:scale-105 transition-transform duration-300 relative";
                    card.dataset.productId = p.id;
                    card.innerHTML = `
                        ${p.originalPrice ? `<span class="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">SALE</span>` : ''}
                        <button data-action="toggleFavorite" class="favorite-btn absolute top-4 right-4 hover:text-red-500 transition ${isFav ? 'favorited' : ''}">
                            <svg class="w-6 h-6 pointer-events-none" xmlns="http://www.w3.org/2000/svg" ${isFav ? 'fill="currentColor"' : 'fill="none"'} viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg>
                        </button>
                        <img class="w-full h-52 object-cover rounded-md mb-4" src="${p.image}" alt="${p.name}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1e293b/ffffff?text=Image+Error';">
                        <div class="flex-grow">
                            <h4 class="text-lg font-bold mb-2">${p.name}</h4>
                            <div class="flex items-baseline gap-2">
                                <p class="text-xl font-semibold text-yellow-400">৳${p.price.toLocaleString('bn-BD')}</p>
                                ${originalPriceHTML}
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            <button data-action="addToCart" class="w-full bg-yellow-500 hover:bg-yellow-600 font-bold py-2 px-3 rounded-lg transition duration-300 text-sm" data-lang-key="add_to_cart_btn"></button>
                            <button data-action="buyNow" class="w-full bg-gray-600 hover:bg-gray-700 font-bold py-2 px-3 rounded-lg transition duration-300 text-sm" data-lang-key="buy_now_btn"></button>
                        </div>`;
                    listEl.appendChild(card);
                });
                setLanguage(localStorage.getItem('language') || 'bn');
            }

            function renderCart() {
                const itemsEl = document.getElementById('cart-items');
                const totalEl = document.getElementById('cart-total');
                itemsEl.innerHTML = '';
                let selectedTotal = 0;

                if (state.cart.length === 0) {
                    itemsEl.innerHTML = `<p data-lang-key="cart_empty"></p>`;
                } else {
                    state.cart.forEach(item => {
                        const product = state.products.find(p => p.id === item.productId);
                        if (!product) return;

                        const isSelected = state.selectedCartItemIds.has(item.id);
                        if (isSelected) {
                            selectedTotal += product.price * item.quantity;
                        }

                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex items-center gap-4 p-2 rounded-md hover:bg-gray-800 transition';
                        itemEl.innerHTML = `
                            <input type="checkbox" data-cart-item-id="${item.id}" class="cart-item-checkbox h-5 w-5 flex-shrink-0 rounded bg-gray-700 border-gray-600 text-yellow-500 focus:ring-yellow-600 cursor-pointer" ${isSelected ? 'checked' : ''}>
                            <img src="${product.image}" class="w-16 h-16 object-cover rounded-md">
                            <div class="flex-grow">
                                <h5 class="font-semibold">${product.name}</h5>
                                <p class="text-sm">${item.quantity} x ৳${product.price.toLocaleString('bn-BD')}</p>
                            </div>
                            <button data-cart-id="${item.id}" class="text-red-500 hover:text-red-400 text-2xl">&times;</button>
                        `;
                        itemsEl.appendChild(itemEl);
                    });
                }
                
                totalEl.innerText = `৳${selectedTotal.toLocaleString('bn-BD')}`;
                document.getElementById('checkout-btn').disabled = state.selectedCartItemIds.size === 0;

                setLanguage(localStorage.getItem('language') || 'bn');
            }
            
            function renderFavoritesInDashboard() {
                const favListEl = document.getElementById('favorites-list');
                favListEl.innerHTML = '';
                const favoritedProducts = state.products.filter(p => state.favorites.includes(p.id));
                if (favoritedProducts.length === 0) {
                    favListEl.innerHTML = `<p class="col-span-full" data-lang-key="favorites_none"></p>`;
                } else {
                    favoritedProducts.forEach(p => {
                        const card = document.createElement('div');
                        card.className = "glass-effect rounded-lg p-4 flex flex-col";
                        card.innerHTML = `
                            <img src="${p.image}" class="w-full h-32 object-cover rounded-md mb-3">
                            <h5 class="font-semibold flex-grow">${p.name}</h5>
                            <p class="text-yellow-400 mt-1">৳${p.price.toLocaleString('bn-BD')}</p>`;
                        favListEl.appendChild(card);
                    });
                }
                setLanguage(localStorage.getItem('language') || 'bn');
            }
            
            function renderOrders(orders) {
                const ordersListEl = document.getElementById('orders-list');
                if (!ordersListEl) return;
                ordersListEl.innerHTML = '';
                if (orders.length === 0) {
                    ordersListEl.innerHTML = `<p data-lang-key="orders_none"></p>`;
                    setLanguage(localStorage.getItem('language') || 'bn');
                    return;
                }

                orders.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());

                orders.forEach(order => {
                    const orderDate = order.createdAt ? order.createdAt.toDate().toLocaleString('bn-BD', { dateStyle: 'long', timeStyle: 'short' }) : 'N/A';
                    
                    const itemsDetails = order.items.map(item => {
                        const product = state.products.find(p => p.id === item.productId);
                        return product ? `<li>${product.name} (x${item.quantity})</li>` : `<li>Product ID: ${item.productId}</li>`;
                    }).join('');

                    const statusClass = order.status === 'pending' ? 'bg-yellow-500' : (order.status === 'completed' ? 'bg-green-500 text-white' : 'bg-red-500 text-white');
                    const statusText = order.status || 'N/A';

                    const orderEl = document.createElement('div');
                    orderEl.className = 'border-b border-gray-700 py-4 last:border-b-0';
                    orderEl.innerHTML = `
                        <div class="flex justify-between items-start flex-wrap">
                            <div>
                                <p class="font-bold text-base">অর্ডার আইডি:</p>
                                <p class="text-xs mb-2">${order.id}</p>
                                <p class="text-sm">তারিখ: ${orderDate}</p>
                            </div>
                            <div class="text-right mt-2 sm:mt-0">
                                <p class="font-bold text-lg text-yellow-400">৳${order.totalAmount.toLocaleString('bn-BD')}</p>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <p class="font-semibold text-sm">ক্রয়কৃত পণ্য:</p>
                            <ul class="list-disc list-inside text-sm pl-2">
                                ${itemsDetails}
                            </ul>
                        </div>
                    `;
                    ordersListEl.appendChild(orderEl);
                });
            }

            function renderBanners() {
                const sliderContainer = document.getElementById('slider');
                const existingSlides = sliderContainer.querySelectorAll('.slide');
                existingSlides.forEach(slide => slide.remove());

                if (state.banners.length === 0) {
                    sliderContainer.insertAdjacentHTML('afterbegin', `
                        <div class="slide active">
                            <img src="https://placehold.co/1920x1080/111827/FBBF24?text=Ismat+Code" alt="Welcome">
                            <div class="slide-content">
                                <h2 class="text-3xl font-bold">ইসমত কোডে স্বাগতম</h2>
                                <p>আপনার সব ডিজিটাল পণ্যের নির্ভরযোগ্য সমাধান।</p>
                            </div>
                        </div>
                    `);
                } else {
                    [...state.banners].reverse().forEach((banner, index) => {
                        const slideHTML = `
                            <div class="slide ${index === 0 ? 'active' : ''}">
                                <img src="${banner.image}" alt="${banner.title}" onerror="this.onerror=null;this.src='https://placehold.co/1920x1080/1e293b/ffffff?text=Image+Error';">
                                <div class="slide-content">
                                    <h2 class="text-3xl font-bold">${banner.title}</h2>
                                    <p>${banner.description}</p>
                                </div>
                            </div>
                        `;
                        sliderContainer.insertAdjacentHTML('beforeend', slideHTML);
                    });
                }
                initializeSlider();
            }

            function initializeSlider() {
                let currentSlide = 0;
                const slides = document.querySelectorAll('.slide');
                const totalSlides = slides.length;

                if (window.sliderInterval) clearInterval(window.sliderInterval);
                
                if (totalSlides > 0) {
                    const showSlide = i => slides.forEach((s, idx) => s.classList.toggle('active', i === idx));
                    const next = () => { currentSlide = (currentSlide + 1) % totalSlides; showSlide(currentSlide); };
                    
                    const nextBtn = document.getElementById('next-slide');
                    const prevBtn = document.getElementById('prev-slide');
                    const newNextBtn = nextBtn.cloneNode(true);
                    const newPrevBtn = prevBtn.cloneNode(true);
                    nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
                    prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);

                    newNextBtn.addEventListener('click', () => {
                        next();
                        clearInterval(window.sliderInterval);
                        if (totalSlides > 1) window.sliderInterval = setInterval(next, 5000);
                    });
                    newPrevBtn.addEventListener('click', () => {
                        currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
                        showSlide(currentSlide);
                        clearInterval(window.sliderInterval);
                        if (totalSlides > 1) window.sliderInterval = setInterval(next, 5000);
                    });
                    
                    if (totalSlides > 1) {
                        window.sliderInterval = setInterval(next, 5000);
                    }
                }
            }
            
            function listenForProductUpdates() {
                const productsCol = collection(db, `artifacts/${appId}/public/data/products`);
                if (state.unsubscribeProducts) state.unsubscribeProducts();
                state.unsubscribeProducts = onSnapshot(productsCol, (snapshot) => {
                    state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const newCategories = ['All', ...new Set(state.products.map(p => p.category))];
                    const categoryContainer = document.getElementById('category-filters');
                    if (categoryContainer.children.length !== newCategories.length) {
                        categoryContainer.innerHTML = newCategories.map(c => `<button class="category-btn px-4 py-2 rounded-full text-sm font-semibold transition ${c === state.currentCategory ? 'active' : ''}" data-category="${c}">${c}</button>`).join('');
                    }
                    renderProducts();
                    if (!document.getElementById('dashboard').classList.contains('hidden')) {
                        renderFavoritesInDashboard();
                    }
                }, (error) => {
                    console.error("Error listening to product updates:", error);
                    showNotification("প্রোডাক্টের তালিকা আপডেট করা সম্ভব হয়নি।", "error");
                });
            }

            function listenForBannerUpdates() {
                const bannersCol = collection(db, `artifacts/${appId}/public/data/banners`);
                if(state.unsubscribeBanners) state.unsubscribeBanners();
                state.unsubscribeBanners = onSnapshot(bannersCol, (snapshot) => {
                    state.banners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderBanners();
                }, (error) => {
                    console.error("Error fetching banners:", error);
                });
            }

            function listenForSiteSettings() {
                const settingsRef = doc(db, `artifacts/${appId}/public/data/site_settings/details`);
                if (state.unsubscribeSiteSettings) state.unsubscribeSiteSettings();
                state.unsubscribeSiteSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        state.siteSettings = docSnap.data();
                        document.getElementById('gateway-number').innerText = state.siteSettings.gatewayNumber || 'N/A';
                        document.getElementById('gateway-name').innerText = state.siteSettings.gatewayName || 'N/A';
                    } else {
                        document.getElementById('gateway-number').innerText = '01XXXXXXXXX';
                        document.getElementById('gateway-name').innerText = 'bKash/Nagad';
                    }
                }, (error) => {
                    console.error("Error fetching site settings:", error);
                    document.getElementById('gateway-number').innerText = 'Unavailable';
                    document.getElementById('gateway-name').innerText = 'Error';
                });
            }

            const handleUserAction = (action, productId) => {
                if (!state.user || state.user.isAnonymous) {
                    showNotification('এই ফিচারটি ব্যবহার করতে লগইন করুন।', 'error');
                    document.getElementById('auth-modal').classList.add('active');
                    return;
                }
                switch (action) {
                    case 'addToCart': addToCart(productId); break;
                    case 'buyNow': buyNow(productId); break;
                    case 'toggleFavorite': toggleFavorite(productId); break;
                }
            };
            
            async function addToCart(productId) {
                try {
                    const cartCol = collection(db, `artifacts/${appId}/users/${state.user.uid}/cart`);
                    await addDoc(cartCol, { productId, quantity: 1, addedAt: serverTimestamp() });
                    showNotification('পণ্যটি কার্টে যোগ করা হয়েছে।');
                } catch (e) { showNotification('কার্টে যোগ করতে সমস্যা হয়েছে।', 'error'); }
            }
            
            function buyNow(productId) {
                const product = state.products.find(p => p.id === productId);
                if (product) {
                    const itemsToCheckout = [{ productId: product.id, quantity: 1 }];
                    startCheckoutProcess(itemsToCheckout);
                } else {
                    showNotification('প্রোডাক্ট খুঁজে পাওয়া যায়নি।', 'error');
                }
            }
            
            function startCheckoutProcess(items) {
                if (!state.user || state.user.isAnonymous) {
                    showNotification('অনুগ্রহ করে চেকআউট করার জন্য লগইন করুন।', 'error');
                    document.getElementById('auth-modal').classList.add('active');
                    return;
                }
                
                if (!items || items.length === 0) {
                    showNotification('চেকআউট করার জন্য কোনো পণ্য নেই।', 'error');
                    return;
                }

                const totalAmount = items.reduce((acc, item) => {
                    const product = state.products.find(p => p.id === item.productId);
                    return acc + (product ? product.price * item.quantity : 0);
                }, 0);

                if (totalAmount <= 0) {
                    showNotification('পেমেন্টের পরিমাণ গণনা করা যায়নি।', 'error');
                    return;
                }

                state.checkoutItems = items;

                document.getElementById('cart-modal').classList.remove('active');
                
                const paymentModal = document.getElementById('payment-modal');
                document.getElementById('payment-amount').innerText = `৳${totalAmount.toLocaleString('bn-BD')}`;
                paymentModal.classList.add('active');
            }

            async function toggleFavorite(productId) {
                try {
                    const favCol = collection(db, `artifacts/${appId}/users/${state.user.uid}/favorites`);
                    const q = query(favCol, where("productId", "==", productId));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        await addDoc(favCol, { productId, addedAt: serverTimestamp() });
                        showNotification('পণ্যটি ফেভারিটে যোগ করা হয়েছে।');
                    } else {
                        await deleteDoc(snapshot.docs[0].ref);
                        showNotification('পণ্যটি ফেভারিট থেকে মুছে ফেলা হয়েছে।');
                    }
                } catch (e) { console.error(e); showNotification('ফেভারিট পরিবর্তন করতে সমস্যা হয়েছে।', 'error'); }
            }
            
            async function fetchUserProfile() {
                if (!state.user || state.user.isAnonymous) return;
                const docRef = doc(db, `artifacts/${appId}/users/${state.user.uid}/profile/details`);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profile-full-name').innerText = data.fullName || '';
                    document.getElementById('profile-email').innerText = data.email || '';
                    document.getElementById('profile-mobile').innerText = data.mobile || '';
                    document.getElementById('settings-address').value = data.address || '';
                    document.getElementById('settings-house').value = data.houseNumber || '';
                    document.getElementById('settings-zip').value = data.zipCode || '';
                    document.getElementById('payout-method').value = data.payoutMethod || 'bKash';
                    document.getElementById('payout-number').value = data.payoutNumber || '';
                }
            }
            
            function showDashboardPage(targetPageId) {
                document.getElementById('main-content').classList.add('hidden');
                const dashboard = document.getElementById('dashboard');
                dashboard.classList.remove('hidden');
                
                dashboard.querySelectorAll('.dashboard-nav-item').forEach(el => el.classList.remove('active'));
                dashboard.querySelectorAll('.dashboard-content').forEach(el => el.classList.add('hidden'));

                const navItem = dashboard.querySelector(`[data-target="${targetPageId}"]`);
                const contentPane = document.getElementById(targetPageId);
                
                if (navItem) navItem.classList.add('active');
                if (contentPane) contentPane.classList.remove('hidden');

                dashboard.scrollIntoView({ behavior: 'smooth' });
            }

            onAuthStateChanged(auth, user => {
                state.unsubscribeCart();
                state.unsubscribeFavorites();
                if (state.unsubscribeOrders) state.unsubscribeOrders();
                state.user = user;
                
                if (user && !user.isAnonymous) {
                    setLanguage(localStorage.getItem('language') || 'bn'); 
                    const cartCol = collection(db, `artifacts/${appId}/users/${user.uid}/cart`);
                    state.unsubscribeCart = onSnapshot(cartCol, s => {
                        state.cart = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        document.getElementById('cart-count').textContent = state.cart.length;
                        renderCart();
                    });
                    const favCol = collection(db, `artifacts/${appId}/users/${user.uid}/favorites`);
                    state.unsubscribeFavorites = onSnapshot(favCol, s => {
                        state.favorites = s.docs.map(d => d.data().productId);
                        document.getElementById('favorite-count').textContent = state.favorites.length;
                        renderProducts();
                        renderFavoritesInDashboard();
                    });
                    
                    const ordersCol = collection(db, `artifacts/${appId}/users/${user.uid}/orders`);
                    state.unsubscribeOrders = onSnapshot(ordersCol, (snapshot) => {
                        const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderOrders(orders);
                    }, (err) => {
                        console.error("Error fetching orders:", err);
                        showNotification("অর্ডার তালিকা লোড করা যায়নি।", "error");
                    });

                    fetchUserProfile();
                } else {
                    state.cart = []; state.favorites = [];
                    document.getElementById('cart-count').textContent = 0;
                    document.getElementById('favorite-count').textContent = 0;
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('dashboard').classList.add('hidden');
                    renderProducts();
                    renderOrders([]);
                    setLanguage(localStorage.getItem('language') || 'bn');
                }
            });
            
            (async () => {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (error) { console.error("Auth error:", error); }
            })();
            
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const themeToggleBtn = document.getElementById('theme-toggle-btn');
                    const sunIcon = document.getElementById('sun-icon');
                    const moonIcon = document.getElementById('moon-icon');

                    const updateThemeIcons = (theme) => {
                        if (theme === 'light') {
                            moonIcon.classList.add('hidden');
                            sunIcon.classList.remove('hidden');
                        } else {
                            sunIcon.classList.add('hidden');
                            moonIcon.classList.remove('hidden');
                        }
                    };

                    const applyTheme = (theme) => {
                        if (theme === 'light') {
                            document.body.classList.add('light-mode');
                        } else {
                            document.body.classList.remove('light-mode');
                        }
                        updateThemeIcons(theme);
                        localStorage.setItem('theme', theme);
                    };

                    const toggleTheme = () => {
                        const currentTheme = localStorage.getItem('theme') || 'dark';
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        applyTheme(newTheme);
                    };
                    
                    const savedTheme = localStorage.getItem('theme') || 'dark';
                    applyTheme(savedTheme);

                    themeToggleBtn.addEventListener('click', toggleTheme);

                    setLanguage(localStorage.getItem('language') || 'bn');
                    
                    const authModal = document.getElementById('auth-modal');
                    const cartModal = document.getElementById('cart-modal');
                    const termsModal = document.getElementById('terms-modal');
                    
                    document.getElementById('auth-btn').addEventListener('click', () => {
                         if (state.user && !state.user.isAnonymous) signOut(auth);
                         else authModal.classList.add('active');
                    });
                    document.getElementById('cart-icon').addEventListener('click', () => cartModal.classList.add('active'));
                    document.getElementById('terms-link').addEventListener('click', e => { e.preventDefault(); termsModal.classList.add('active'); });
                    
                    document.body.addEventListener('click', e => {
                        if (e.target.id === 'register-terms-link') {
                            e.preventDefault();
                            termsModal.classList.add('active');
                        }
                    });

                    document.getElementById('checkout-btn').addEventListener('click', () => {
                        if (state.selectedCartItemIds.size > 0) {
                            const itemsToCheckout = state.cart.filter(item => state.selectedCartItemIds.has(item.id));
                            startCheckoutProcess(itemsToCheckout);
                        } else {
                            showNotification('অনুগ্রহ করে কেনার জন্য পণ্য নির্বাচন করুন।', 'error');
                        }
                    });
                    
                    document.getElementById('close-auth-modal').addEventListener('click', () => authModal.classList.remove('active'));
                    document.getElementById('close-cart-modal').addEventListener('click', () => cartModal.classList.remove('active'));
                    document.getElementById('close-terms-modal').addEventListener('click', () => termsModal.classList.remove('active'));
                    document.getElementById('close-payment-modal').addEventListener('click', () => document.getElementById('payment-modal').classList.remove('active'));

                    document.getElementById('show-register-view').addEventListener('click', () => {
                        document.getElementById('login-view').classList.add('hidden');
                        document.getElementById('register-view').classList.remove('hidden');
                    });
                    document.getElementById('show-login-view').addEventListener('click', () => {
                        document.getElementById('login-view').classList.remove('hidden');
                        document.getElementById('register-view').classList.add('hidden');
                    });
                    
                    document.getElementById('login-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        try {
                            await signInWithEmailAndPassword(auth, e.target['login-email'].value, e.target['login-password'].value);
                            authModal.classList.remove('active');
                            showNotification('সফলভাবে লগইন করেছেন।');
                        } catch (err) { showNotification('ইমেইল বা পাসওয়ার্ড ভুল।', 'error'); }
                    });

                    document.getElementById('register-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        const name = e.target['register-name'].value;
                        const mobile = e.target['register-mobile'].value;
                        const email = e.target['register-email'].value;
                        const password = e.target['register-password'].value;
                        const confirmPassword = e.target['register-confirm-password'].value;
                        const terms = e.target['register-terms'].checked;

                        if (password !== confirmPassword) {
                            showNotification('পাসওয়ার্ড মেলেনি।', 'error');
                            return;
                        }
                        if (!terms) {
                            showNotification('শর্তাবলীতে সম্মত হতে হবে।', 'error');
                            return;
                        }

                        try {
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            const user = userCredential.user;

                            const profileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/details`);
                            await setDoc(profileRef, {
                                fullName: name,
                                mobile: mobile,
                                email: email,
                                createdAt: serverTimestamp()
                            });

                            authModal.classList.remove('active');
                            showNotification('অ্যাকাউন্ট সফলভাবে তৈরি হয়েছে।');
                        } catch (err) { 
                            console.error("Registration error:", err);
                            if (err.code === 'auth/email-already-in-use') {
                                showNotification('এই ইমেইলটি ஏற்கனவே ব্যবহৃত হয়েছে।', 'error');
                            } else if (err.code === 'auth/weak-password') {
                                showNotification('পাসওয়ার্ডটি দুর্বল। কমপক্ষে ৬টি অক্ষর ব্যবহার করুন।', 'error');
                            } else {
                                showNotification('রেজিস্ট্রেশন ব্যর্থ হয়েছে।', 'error');
                            }
                        }
                    });

                    document.getElementById('upload-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        if(!state.user || state.user.isAnonymous) {
                            showNotification('পণ্য আপলোড করতে লগইন করুন।', 'error');
                            return;
                        }
                        const name = document.getElementById('upload-name').value;
                        const description = document.getElementById('upload-desc').value;
                        const price = parseFloat(document.getElementById('upload-price').value);
                        const category = document.getElementById('upload-category').value;
                        const image = document.getElementById('upload-image').value;

                        if (!name || !price || !category || !image) {
                            showNotification('অনুগ্রহ করে সকল প্রয়োজনীয় ফিল্ড পূরণ করুন।', 'error');
                            return;
                        }

                        try {
                            const productsCol = collection(db, `artifacts/${appId}/public/data/products`);
                            await addDoc(productsCol, {
                                name,
                                description,
                                price,
                                category,
                                image,
                                sellerId: state.user.uid,
                                createdAt: serverTimestamp()
                            });
                            showNotification('আপনার পণ্য সফলভাবে আপলোড হয়েছে।');
                            e.target.reset();
                            showDashboardPage('my-orders');
                        } catch (err) {
                            console.error("Product upload error: ", err);
                            showNotification('পণ্য আপলোড করতে সমস্যা হয়েছে।', 'error');
                        }
                    });
                    
                    document.getElementById('settings-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        if(!state.user || state.user.isAnonymous) { showNotification('প্রথমে লগইন করুন।', 'error'); return; }
                        try {
                            const docRef = doc(db, `artifacts/${appId}/users/${state.user.uid}/profile/details`);
                            await setDoc(docRef, {
                                address: e.target['settings-address'].value,
                                houseNumber: e.target['settings-house'].value,
                                zipCode: e.target['settings-zip'].value,
                                payoutMethod: e.target['payout-method'].value,
                                payoutNumber: e.target['payout-number'].value,
                            }, { merge: true }); 
                            showNotification('আপনার তথ্য সেভ করা হয়েছে।');
                        } catch (err) { showNotification('তথ্য সেভ করা যায়নি।', 'error');}
                    });
                    
                     document.getElementById('payment-form').addEventListener('submit', async e => {
                             e.preventDefault();
                             const paymentModal = document.getElementById('payment-modal');
                             const totalAmountForOrder = state.checkoutItems.reduce((acc, item) => {
                                 const product = state.products.find(p => p.id === item.productId);
                                 return acc + (product ? product.price * item.quantity : 0);
                             }, 0);

                             const orderDetails = {
                                 userId: state.user.uid,
                                 items: state.checkoutItems.map(item => ({productId: item.productId, quantity: item.quantity})),
                                 totalAmount: totalAmountForOrder,
                                 paymentPhone: e.target['payment-phone'].value,
                                 paymentTrxId: e.target['payment-trxid'].value,
                                 status: 'pending',
                                 createdAt: serverTimestamp()
                             };
                             try {
                                 // CORRECTED: Save order to the user's private collection
                                 const ordersCol = collection(db, `artifacts/${appId}/users/${state.user.uid}/orders`);
                                 await addDoc(ordersCol, orderDetails);
                                 
                                 const purchasedCartItemIds = new Set(
                                     state.checkoutItems
                                         .filter(item => item.id)
                                         .map(item => item.id)
                                 );

                                 if (purchasedCartItemIds.size > 0) {
                                     const batch = writeBatch(db);
                                     purchasedCartItemIds.forEach(cartId => {
                                         const docRef = doc(db, `artifacts/${appId}/users/${state.user.uid}/cart`, cartId);
                                         batch.delete(docRef);
                                     });
                                     await batch.commit();
                                 }

                                 state.checkoutItems = [];
                                 state.selectedCartItemIds.clear();

                                 paymentModal.classList.remove('active');
                                 showNotification('আপনার অর্ডারটি গ্রহণ করা হয়েছে।');
                                 e.target.reset();
                                 showDashboardPage('my-orders');

                             } catch (err) {
                                 console.error("Order submission error:", err);
                                 showNotification('অর্ডার কনফার্ম করা যায়নি।', 'error');
                             }
                         });
                    
                    document.getElementById('product-list').addEventListener('click', e => {
                        const button = e.target.closest('button[data-action]');
                        if (button) {
                            handleUserAction(button.dataset.action, button.closest('[data-product-id]').dataset.productId);
                        }
                    });

                     document.getElementById('cart-items').addEventListener('click', async e => {
                             const checkbox = e.target.closest('.cart-item-checkbox');
                             if (checkbox) {
                                 const cartItemId = checkbox.dataset.cartItemId;
                                 if (checkbox.checked) {
                                     state.selectedCartItemIds.add(cartItemId);
                                 } else {
                                     state.selectedCartItemIds.delete(cartItemId);
                                 }
                                 renderCart();
                                 return;
                             }
                             
                             const button = e.target.closest('button[data-cart-id]');
                             if (button) {
                                 const cartId = button.dataset.cartId;
                                 try {
                                     const docRef = doc(db, `artifacts/${appId}/users/${state.user.uid}/cart`, cartId);
                                     await deleteDoc(docRef);
                                     state.selectedCartItemIds.delete(cartId);
                                     showNotification('কার্ট থেকে পণ্য মুছে ফেলা হয়েছে।');
                                 } catch (err) {
                                      showNotification('পণ্যটি মুছতে সমস্যা হয়েছে।', 'error');
                                 }
                             }
                         });

                    document.getElementById('lang-bn').addEventListener('click', () => setLanguage('bn'));
                    document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
                    
                    const setupDashboardLink = (id) => {
                         document.getElementById(id).addEventListener('click', e => {
                             e.preventDefault();
                             if(!state.user || state.user.isAnonymous) { 
                                 showNotification('অনুগ্রহ করে প্রথমে লগইন করুন।', 'error'); 
                                 authModal.classList.add('active'); 
                                 return; 
                             }
                             showDashboardPage(e.currentTarget.dataset.targetPage || 'my-orders');
                         });
                    }

                    document.getElementById('dashboard-link').addEventListener('click', e => {
                        e.preventDefault();
                        if(!state.user || state.user.isAnonymous) { showNotification('অনুগ্রহ করে প্রথমে লগইন করুন।', 'error'); authModal.classList.add('active'); return; }
                        showDashboardPage('my-orders');
                    });
                    document.getElementById('sell-product-link').addEventListener('click', e => {
                        e.preventDefault();
                        if(!state.user || state.user.isAnonymous) { showNotification('আপনার পণ্য সেল করতে লগইন করুন।', 'error'); authModal.classList.add('active'); return; }
                        showDashboardPage('upload-product');
                    });
                    document.getElementById('favorite-icon').addEventListener('click', e => {
                        e.preventDefault();
                        if(!state.user || state.user.isAnonymous) { showNotification('অনুগ্রহ করে প্রথমে লগইন করুন।', 'error'); authModal.classList.add('active'); return; }
                        showDashboardPage('my-favorites');
                    });

                    document.getElementById('home-link').addEventListener('click', e => {
                        e.preventDefault();
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('dashboard').classList.add('hidden');
                    });

                    document.getElementById('dashboard-nav').addEventListener('click', e => {
                        if(e.target.tagName === 'BUTTON') {
                            const targetId = e.target.dataset.target;
                            document.querySelectorAll('.dashboard-nav-item').forEach(el => el.classList.remove('active'));
                            e.target.classList.add('active');
                            document.querySelectorAll('.dashboard-content').forEach(el => el.classList.add('hidden'));
                            document.getElementById(targetId).classList.remove('hidden');
                        }
                    });
                    document.getElementById('category-filters').addEventListener('click', e => {
                        if(e.target.tagName === 'BUTTON') {
                            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');
                            state.currentCategory = e.target.dataset.category;
                            renderProducts();
                        }
                    });
                    document.getElementById('search-bar').addEventListener('input', e => {
                        state.searchTerm = e.target.value.toLowerCase();
                        renderProducts();
                    });
                    
                    listenForProductUpdates();
                    listenForBannerUpdates();
                    listenForSiteSettings();

                } catch(e) {
                     console.error("A critical error occurred on DOMContentLoaded:", e);
                     const loadingIndicator = document.getElementById('loading-indicator');
                     if (loadingIndicator) {
                         loadingIndicator.innerHTML = '<p class="text-lg text-red-500" data-lang-key="critical_error"></p>';
                         setLanguage(localStorage.getItem('language') || 'bn');
                     }
                     showNotification("অ্যাপ্লিকেশন শুরু করা যায়নি।", "error");
                }
            });
        }
    </script>
</body>
</html>
